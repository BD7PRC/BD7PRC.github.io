name: 自动生成QSL卡列表

on:
  push:
    paths:
      - 'qsl/**'  # 监控qsl文件夹变化
  workflow_dispatch:  # 允许手动触发

jobs:
  generate-list:
    runs-on: ubuntu-latest

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: 确保qsl文件夹存在
        run: |
          # 手动创建qsl文件夹（防止文件夹不存在导致的错误）
          if [ ! -d "qsl" ]; then
            mkdir -p qsl
            echo "创建qsl文件夹"
          fi

      - name: 生成QSL列表（带错误处理）
        run: |
          node -e "
            try {
              const fs = require('fs').promises;
              const path = require('path');
              
              async function generateList() {
                const qslDir = path.join(__dirname, 'qsl');
                
                // 读取文件夹内容
                const files = await fs.readdir(qslDir);
                
                // 筛选JPG文件并排序
                const qslFiles = files
                  .filter(file => file.toLowerCase().endsWith('.jpg'))
                  .map(file => `qsl/${file}`)
                  .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
                
                // 写入JSON文件
                await fs.writeFile(
                  'qsl-list.json',
                  JSON.stringify(qslFiles, null, 2)
                );
                
                console.log(\`成功生成 \${qslFiles.length} 张QSL卡列表\`);
              }
              
              generateList().catch(err => {
                console.error('生成列表失败:', err);
                process.exit(1); // 明确返回错误码
              });
            } catch (err) {
              console.error('脚本执行错误:', err);
              process.exit(1);
            }
          "

      - name: 提交更新
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "自动更新QSL卡列表"
          file_pattern: "qsl-list.json"
          commit_user_name: "QSL Bot"
          commit_user_email: "qsl-bot@example.com"
