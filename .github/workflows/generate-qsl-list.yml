name: 自动生成QSL卡列表

on:
  push:
    paths:
      - 'qsl/**'  # 监控qsl文件夹变化
  workflow_dispatch:  # 允许手动触发

jobs:
  generate-list:
    runs-on: ubuntu-latest

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: 确保qsl文件夹存在
        run: |
          if [ ! -d "qsl" ]; then
            mkdir -p qsl
            echo "创建qsl文件夹"
          fi

      - name: 生成QSL列表（修正语法错误）
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const qslDir = path.join(__dirname, 'qsl');
            
            try {
              // 读取qsl文件夹中的所有文件
              const files = fs.readdirSync(qslDir);
              
              // 筛选JPG文件并生成相对路径
              const qslFiles = files
                .filter(file => {
                  // 排除文件夹，只保留文件
                  const filePath = path.join(qslDir, file);
                  return fs.statSync(filePath).isFile() && 
                         file.toLowerCase().endsWith('.jpg');
                })
                .map(file => `qsl/${file}`)  // 正确生成路径
                .sort((a, b) => a.localeCompare(b));  // 排序
              
              // 写入JSON文件
              fs.writeFileSync('qsl-list.json', JSON.stringify(qslFiles, null, 2));
              console.log(\`成功生成 \${qslFiles.length} 张QSL卡列表\`);
            } catch (err) {
              console.error('生成列表失败:', err.message);
              process.exit(1);
            }
          "

      - name: 提交更新
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "自动更新QSL卡列表"
          file_pattern: "qsl-list.json"
          commit_user_name: "QSL Bot"
          commit_user_email: "qsl-bot@example.com"
