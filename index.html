<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BD7PRC的QSL卡展示</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#1e40af' }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .card-hover { @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1; }
      .filter-active { @apply bg-primary text-white; }
      .image-container {
        @apply relative overflow-hidden bg-gray-100 rounded cursor-pointer;
        padding-top: 100%; /* 1:1 Aspect Ratio */
      }
      .image-container img {
        @apply absolute top-0 left-0 w-full h-full object-cover transition-transform duration-300;
      }
      .image-container:hover img {
        @apply scale-105;
      }
      .error-overlay {
        @apply absolute inset-0 bg-gray-200 flex flex-col items-center justify-center text-gray-500;
      }
      .modal-image-container {
        @apply relative max-w-full max-h-[80vh] transition-transform duration-300;
      }
      /* 翻页动画相关样式 */
      .flip-container {
        perspective: 1000px;
        width: 100%;
        height: 100%;
      }
      .flip-card {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.8s;
        transform-style: preserve-3d;
      }
      .flip-card.flipped {
        transform: rotateY(180deg);
      }
      .flip-front, .flip-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .flip-back {
        transform: rotateY(180deg);
      }
      /* DXCC统计样式 */
      .dxcc-badge {
        @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200;
      }
      .dxcc-badge:hover {
        @apply bg-blue-200;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <header class="bg-primary text-white py-4">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-2xl font-bold"><i class="fa fa-radio mr-2"></i>BD7PRC的QSL卡展示</h1>
      <p class="text-sm mt-1">BD7PRC's QSL card display</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- 搜索区域 -->
    <div class="max-w-2xl mx-auto mb-8">
      <div class="flex">
        <input 
          type="text" 
          id="callsign-search" 
          placeholder="输入呼号搜索..." 
          class="flex-1 px-4 py-2 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary"
        >
        <button 
          id="search-btn" 
          class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary/90 transition-colors"
        >
          <i class="fa fa-search"></i> 搜索Search
        </button>
      </div>
    </div>

    <!-- 筛选和分页控制区 -->
    <div class="mb-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <!-- 左侧：新增分类（6米/卫星）→ 首字母筛选 → DXCC统计 -->
        <div class="flex flex-wrap items-center gap-4">
          <!-- 新增：6米/卫星分类筛选 -->
          <div class="flex flex-wrap gap-2">
            <span class="text-sm text-gray-600 self-center">类型筛选:</span>
            <button class="type-filter-btn px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100 transition-colors filter-active" data-type="all" disabled>全部</button>
            <button class="type-filter-btn px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100 transition-colors" data-type="6m">6米波段</button>
            <button class="type-filter-btn px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100 transition-colors" data-type="SAT">卫星</button>
          </div>

          <!-- 首字母筛选 -->
          <div class="flex flex-wrap gap-2">
            <span class="text-sm text-gray-600 self-center">首字母筛选:</span>
            <button class="filter-btn px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100 transition-colors filter-active" data-letter="all" disabled>全部</button>
            <!-- A-Z字母按钮会动态生成 -->
          </div>

          <!-- DXCC统计 -->
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">DXCC统计:</span>
            <div id="dxcc-stats" class="flex flex-wrap gap-1 max-w-md">
              <div class="text-sm text-gray-500">加载中...</div>
            </div>
          </div>
        </div>

        <!-- 右侧：分页控制 -->
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">每页显示:</span>
            <select id="per-page" class="border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <button id="prev-page" class="px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100 transition-colors" disabled>
              <i class="fa fa-chevron-left"></i> 上一页
            </button>
            <span id="page-info" class="text-sm text-gray-600">第 1 页</span>
            <button id="next-page" class="px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100 transition-colors" disabled>
              下一页 <i class="fa fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 最后更新时间 -->
    <div id="last-update" class="text-right text-sm text-gray-500 mb-4">
      最后更新：加载中...
    </div>
    
    <!-- QSL卡展示区 -->
    <div id="qsl-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
      <!-- 卡片将自动生成 -->
      <div class="col-span-full text-center py-16 text-gray-500">
        <i class="fa fa-circle-o-notch fa-spin text-5xl text-primary mb-4"></i>
        <p>加载QSL卡列表中...</p>
      </div>
    </div>

    <!-- 无结果提示 -->
    <div id="no-results" class="hidden col-span-full text-center py-16 text-gray-500">
      <i class="fa fa-search text-5xl mb-4"></i>
      <p>未找到匹配的QSL卡</p>
    </div>

    <!-- 搜索结果弹窗 -->
    <div id="search-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-auto">
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="text-xl font-bold" id="modal-title">搜索结果</h3>
          <button id="close-search-modal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <div class="p-4" id="modal-content">
          <!-- 搜索结果将在这里显示 -->
        </div>
      </div>
    </div>

    <!-- 大图查看弹窗（优化版） -->
    <div id="image-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
      <div class="relative w-full h-full flex flex-col">
        <!-- 顶部控制栏 -->
        <div class="absolute top-0 left-0 right-0 bg-black/70 text-white p-4 z-10 flex justify-between items-center">
          <div>
            <h3 id="modal-image-title" class="text-xl font-bold"></h3>
            <p id="modal-image-side" class="text-sm mt-1">正面</p>
          </div>
          <div class="flex gap-2">
            <button id="flip-card" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors" title="查看背面">
              <i class="fa fa-exchange"></i>
            </button>
            <button id="rotate-image" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors" title="旋转图片">
              <i class="fa fa-rotate-right"></i>
            </button>
            <button id="close-image-modal" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors" title="关闭">
              <i class="fa fa-times"></i>
            </button>
          </div>
        </div>
        
        <!-- 图片显示区域 -->
        <div class="flex-1 flex items-center justify-center p-4 pt-16 pb-16">
          <div class="flip-container max-w-4xl w-full h-full">
            <div class="flip-card" id="flip-card-element">
              <!-- 正面 -->
              <div class="flip-front">
                <div class="modal-image-container w-full h-full">
                  <img id="modal-image-front" src="" alt="QSL卡正面" class="w-full h-full object-contain">
                  <div id="modal-error-front" class="hidden absolute inset-0 bg-gray-200 flex flex-col items-center justify-center text-gray-500">
                    <i class="fa fa-exclamation-circle text-5xl mb-4"></i>
                    <p class="text-xl">图片加载失败</p>
                  </div>
                </div>
              </div>
              <!-- 背面 -->
              <div class="flip-back">
                <div class="modal-image-container w-full h-full">
                  <img id="modal-image-back" src="" alt="QSL卡背面" class="w-full h-full object-contain">
                  <div id="modal-error-back" class="hidden absolute inset-0 bg-gray-200 flex flex-col items-center justify-center text-gray-500">
                    <i class="fa fa-exclamation-circle text-5xl mb-4"></i>
                    <p class="text-xl">背面图片未找到</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 底部信息栏 -->
        <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white p-4 z-10 text-center">
          <p class="text-sm">使用 <i class="fa fa-exchange mx-1"></i> 按钮查看背面，<i class="fa fa-rotate-right mx-1"></i> 按钮旋转图片</p>
        </div>
      </div>
    </div>
  </main>
  
  <footer class="bg-primary text-white py-4 mt-8">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 VR2WAA. 保留所有权利。All rights reserved.</p>
    </div>
  </footer>

  <!-- 代理加速切换按钮 -->
  <div class="fixed bottom-4 right-4 z-50">
    <div class="relative">
      <button id="proxy-toggle" class="bg-yellow-500 hover:bg-yellow-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-colors">
        <i class="fa fa-bolt"></i>
      </button>
      <div id="proxy-dropdown" class="hidden absolute bottom-14 right-0 w-64 bg-white rounded-lg shadow-xl border border-gray-200 py-2">
        <div class="px-4 py-2 text-sm font-medium text-gray-700 border-b border-gray-100">选择图片代理加速</div>
        <ul>
          <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer proxy-option" data-proxy="https://v6.gh-proxy.org/">v6.gh-proxy.org</li>
          <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer proxy-option" data-proxy="https://gh-proxy.org/">gh-proxy.org</li>
          <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer proxy-option" data-proxy="https://hk.gh-proxy.org/">hk.gh-proxy.org</li>
          <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer proxy-option" data-proxy="https://cdn.gh-proxy.org/">cdn.gh-proxy.org</li>
          <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer proxy-option" data-proxy="https://edgeone.gh-proxy.org/">edgeone.gh-proxy.org</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // 配置
    const config = {
      githubUser: "BD7PRC",
      githubRepo: "BD7PRC.github.io",
      qslDir: "qsl",
      cacheExpireMinutes: 10,
      dxccCacheExpireMinutes: 5 // DXCC统计缓存时间
    };

    // 代理配置
    let currentProxy = localStorage.getItem('imageProxy') || 'https://v6.gh-proxy.org/';
    
    // 所有可能的首字母 (A-Z)
    const allLetters = Array.from({length: 26}, (_, i) => String.fromCharCode(65 + i));

    // 状态管理 - 新增类型筛选状态
    let allQslCards = [];
    let filteredCards = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let currentLetterFilter = 'all';
    let currentTypeFilter = 'all'; // 新增：6m/SAT/全部
    let currentRotation = 0; // 图片旋转角度
    let currentCardSide = 'front'; // 当前显示的卡片面：front或back
    let currentCallsign = ''; // 当前显示的呼号
    let currentFrontImageUrl = ''; // 当前正面图片URL
    let dxccStats = {}; // DXCC统计数据

    // 初始化页面
    window.addEventListener('DOMContentLoaded', () => {
      // 生成所有首字母筛选按钮
      generateAllLetterFilters();
      
      // 新增：绑定类型筛选按钮事件
      bindTypeFilterEvents();
      
      loadQslCards();
      setInterval(loadQslCards, config.cacheExpireMinutes * 60 * 1000);
      
      // 事件监听
      document.getElementById('search-btn').addEventListener('click', handleSearch);
      document.getElementById('callsign-search').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSearch();
      });
      document.getElementById('per-page').addEventListener('change', handlePerPageChange);
      document.getElementById('prev-page').addEventListener('click', goToPrevPage);
      document.getElementById('next-page').addEventListener('click', goToNextPage);
      document.getElementById('close-search-modal').addEventListener('click', () => {
        document.getElementById('search-modal').classList.add('hidden');
        document.getElementById('search-modal').classList.remove('flex');
      });
      document.getElementById('close-image-modal').addEventListener('click', closeImageModal);
      
      // 旋转按钮事件监听
      document.getElementById('rotate-image').addEventListener('click', rotateCurrentImage);
      
      // 翻页按钮事件监听
      document.getElementById('flip-card').addEventListener('click', flipCard);
      
      // 点击弹窗背景关闭大图查看
      document.getElementById('image-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('image-modal')) {
          closeImageModal();
        }
      });

      // 大图弹窗图片加载失败处理
      document.getElementById('modal-image-front').addEventListener('error', () => {
        document.getElementById('modal-image-front').classList.add('hidden');
        document.getElementById('modal-error-front').classList.remove('hidden');
      });
      
      document.getElementById('modal-image-back').addEventListener('error', () => {
        document.getElementById('modal-image-back').classList.add('hidden');
        document.getElementById('modal-error-back').classList.remove('hidden');
      });
      
      // 代理切换相关事件
      document.getElementById('proxy-toggle').addEventListener('click', toggleProxyDropdown);
      document.querySelectorAll('.proxy-option').forEach(option => {
        option.addEventListener('click', (e) => {
          const selectedProxy = e.target.getAttribute('data-proxy');
          changeProxy(selectedProxy);
          toggleProxyDropdown();
        });
      });
    });

    // 新增：绑定类型筛选按钮事件
    function bindTypeFilterEvents() {
      document.querySelectorAll('.type-filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // 移除所有类型按钮的激活状态
          document.querySelectorAll('.type-filter-btn').forEach(b => {
            b.classList.remove('filter-active');
            b.disabled = false;
          });
          // 激活当前按钮
          e.target.classList.add('filter-active');
          e.target.disabled = true;
          // 更新当前类型筛选
          currentTypeFilter = e.target.getAttribute('data-type');
          // 重置页码并重新筛选卡片
          currentPage = 1;
          filterAndRenderCards();
        });
      });
    }

    // 切换代理下拉菜单
    function toggleProxyDropdown() {
      const dropdown = document.getElementById('proxy-dropdown');
      dropdown.classList.toggle('hidden');
	  console.log("感谢互联网上每一个愿意开源和具有无私奉献精神的人——BH7GZB");
    }

    // 更改代理设置
    function changeProxy(proxy) {
      currentProxy = proxy;
      localStorage.setItem('imageProxy', proxy);
      // 更新当前显示的所有图片URL
      updateAllImageUrls();
    }

    // 更新所有图片URL以使用新的代理
    function updateAllImageUrls() {
      // 重新加载QSL卡片以应用新代理
      loadQslCards();
    }

    // 使用代理构建图片URL
    function buildProxyUrl(originalUrl) {
      // 确保原URL是raw.githubusercontent.com格式
      if (!originalUrl.includes('raw.githubusercontent.com')) {
        return originalUrl; // 如果不是GitHub raw URL，直接返回
      }
      
      // 移除可能存在的已有代理前缀
      const cleanUrl = originalUrl.replace(/https:\/\/[^\/]*gh-proxy\.org\//, '');
      
      // 构建带代理的URL
      return currentProxy + cleanUrl;
    }

    // 关闭图片弹窗并重置状态
    function closeImageModal() {
      document.getElementById('image-modal').classList.add('hidden');
      document.getElementById('image-modal').classList.remove('flex');
      document.body.style.overflow = '';
      currentRotation = 0; // 重置旋转角度
      document.querySelector('.modal-image-container').style.transform = 'rotate(0deg)';
      currentCardSide = 'front'; // 重置为正面
      document.getElementById('flip-card-element').classList.remove('flipped');
      document.getElementById('modal-image-side').textContent = '正面';
      
      // 重置背面图片状态
      document.getElementById('modal-image-back').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f3f4f6'/%3E%3C/svg%3E";
      document.getElementById('modal-error-back').classList.add('hidden');
    }

    // 旋转当前图片功能
    function rotateCurrentImage() {
      // 每次旋转90度，循环0-270度
      currentRotation = (currentRotation + 90) % 360;
      // 应用旋转样式，带动画效果
      document.querySelector('.modal-image-container').style.transform = `rotate(${currentRotation}deg)`;
    }

    // 翻页功能
    function flipCard() {
      const flipCardElement = document.getElementById('flip-card-element');
      const sideIndicator = document.getElementById('modal-image-side');
      
      if (currentCardSide === 'front') {
        // 切换到背面
        flipCardElement.classList.add('flipped');
        sideIndicator.textContent = '背面';
        currentCardSide = 'back';
        
        // 加载背面图片
        loadBackImage();
      } else {
        // 切换回正面
        flipCardElement.classList.remove('flipped');
        sideIndicator.textContent = '正面';
        currentCardSide = 'front';
      }
    }

    // 加载背面图片
    function loadBackImage() {
      const backImage = document.getElementById('modal-image-back');
      const backError = document.getElementById('modal-error-back');
      
      // 重置状态
      backImage.classList.remove('hidden');
      backError.classList.add('hidden');
      
      // 获取背面图片URL
      const backImageUrl = getBackImageUrl(currentCallsign);
      
      console.log('尝试加载背面图片:', backImageUrl); // 调试用
      
      // 预加载图片检查是否可用
      const testImage = new Image();
      testImage.onload = function() {
        // 背面图片存在，设置图片源
        backImage.src = buildProxyUrl(backImageUrl);
        console.log('背面图片加载成功'); // 调试用
      };
      testImage.onerror = function() {
        // 背面图片不存在，显示错误状态
        backImage.classList.add('hidden');
        backError.classList.remove('hidden');
        console.log('背面图片加载失败'); // 调试用
      };
      testImage.src = buildProxyUrl(backImageUrl);
    }

    // 获取背面图片URL - 修复URL生成逻辑
    function getBackImageUrl(callsign) {
      // 从正面图片URL推断背面图片URL
      const frontUrl = currentFrontImageUrl;
      console.log('正面图片URL:', frontUrl); // 调试用
      
      // 如果正面URL是GitHub的原始内容URL
      if (frontUrl.includes('githubusercontent.com')) {
        // 提取文件名并替换为背面文件名
        const baseUrl = frontUrl.substring(0, frontUrl.lastIndexOf('/') + 1);
        const fileName = frontUrl.substring(frontUrl.lastIndexOf('/') + 1);
        
        // 获取文件扩展名
        const extensionMatch = fileName.match(/\.(jpg|png|jpeg)$/i);
        if (extensionMatch) {
          const extension = extensionMatch[1].toLowerCase();
          const baseName = fileName.replace(/\.(jpg|png|jpeg)$/i, '');
          
          // 构造背面图片URL（兼容6m/SAT后缀）
          let backBaseName = baseName;
          // 先移除_6m/_SAT后缀（如果有），加_B后再加回来
          const typeSuffixMatch = backBaseName.match(/_(6m|SAT)$/);
          let typeSuffix = '';
          if (typeSuffixMatch) {
            typeSuffix = typeSuffixMatch[0];
            backBaseName = backBaseName.replace(typeSuffix, '');
          }
          // 拼接背面文件名：基础名_B_类型后缀.扩展名
          backBaseName = `${backBaseName}_B${typeSuffix}`;
          
          // 构造背面图片URL
          const backUrl = `${baseUrl}${backBaseName}.${extension}`;
          return backUrl;
        }
      }
      // 兼容返回原始逻辑
      return frontUrl.replace(/\.jpg$/, '_B.jpg').replace(/\.png$/, '_B.png').replace(/\.jpeg$/, '_B.jpeg');
    }

    // 生成所有首字母筛选按钮
    function generateAllLetterFilters() {
      const letterFilterContainer = document.querySelector('.filter-btn[data-letter="all"]').parentNode;
      
      allLetters.forEach(letter => {
        const button = document.createElement('button');
        button.className = 'filter-btn px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100 transition-colors';
        button.setAttribute('data-letter', letter);
        button.textContent = letter;
        
        button.addEventListener('click', (e) => {
          // 移除所有字母按钮的激活状态
          document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('filter-active');
            btn.disabled = false;
          });
          // 激活当前按钮
          e.target.classList.add('filter-active');
          e.target.disabled = true;
          // 更新当前字母筛选
          currentLetterFilter = letter;
          // 重置页码并重新筛选卡片
          currentPage = 1;
          filterAndRenderCards();
        });
        
        letterFilterContainer.appendChild(button);
      });
    }

    // 筛选并渲染卡片（核心：新增类型筛选逻辑）
    function filterAndRenderCards() {
      // 1. 应用类型筛选（6m/SAT/全部）
      let tempFiltered = [...allQslCards];
      if (currentTypeFilter !== 'all') {
        tempFiltered = tempFiltered.filter(card => {
          // 匹配文件名中的_6m或_SAT后缀（忽略_B）
          const fileName = card.name.toLowerCase();
          // 先移除_B后缀，再检查类型
          const nameWithoutBack = fileName.replace(/_b/, '');
          return nameWithoutBack.includes(`_${currentTypeFilter.toLowerCase()}`);
        });
      }

      // 2. 应用首字母筛选
      if (currentLetterFilter !== 'all') {
        tempFiltered = tempFiltered.filter(card => {
          // 提取呼号首字母（忽略_6m/_SAT/_B后缀）
          const callsign = getPureCallsign(card.name);
          return callsign.charAt(0).toUpperCase() === currentLetterFilter;
        });
      }

      // 3. 更新筛选后的数据
      filteredCards = tempFiltered;

      // 4. 处理分页
      const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const cardsToRender = filteredCards.slice(startIndex, endIndex);

      // 5. 更新分页控件状态
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = currentPage === totalPages || filteredCards.length === 0;
      document.getElementById('page-info').textContent = `第 ${currentPage} 页 / 共 ${Math.max(totalPages, 1)} 页`;

      // 6. 渲染卡片
      const container = document.getElementById('qsl-container');
      container.innerHTML = '';

      if (cardsToRender.length === 0) {
        // 显示无结果
        document.getElementById('no-results').classList.remove('hidden');
      } else {
        // 隐藏无结果
        document.getElementById('no-results').classList.add('hidden');
        // 渲染卡片
        cardsToRender.forEach(card => {
          const cardElement = createCardElement(card);
          container.appendChild(cardElement);
        });
      }
    }

    // 新增：提取纯呼号（移除_B/_6m/_SAT后缀和扩展名）
    function getPureCallsign(fileName) {
      // 步骤：1. 移除扩展名 2. 移除_B 3. 移除_6m/_SAT
      let pureName = fileName.replace(/\.(jpg|png|jpeg)$/i, ''); // 移除扩展名
      pureName = pureName.replace(/_B/i, ''); // 移除_B
      pureName = pureName.replace(/_6m/i, '').replace(/_SAT/i, ''); // 移除_6m/_SAT
      return pureName;
    }

    // 创建卡片元素
    function createCardElement(card) {
      const pureCallsign = getPureCallsign(card.name);
      const cardDiv = document.createElement('div');
      cardDiv.className = 'card-hover';
      
      const imageContainer = document.createElement('div');
      imageContainer.className = 'image-container';
      
      const img = document.createElement('img');
      img.src = buildProxyUrl(card.download_url);
      img.alt = pureCallsign;
      img.loading = 'lazy';
      
      // 图片加载失败处理
      img.addEventListener('error', () => {
        imageContainer.innerHTML = `
          <div class="error-overlay">
            <i class="fa fa-exclamation-circle text-5xl mb-4"></i>
            <p class="text-xl">图片加载失败</p>
          </div>
        `;
      });
      
      // 点击卡片打开大图
      imageContainer.addEventListener('click', () => {
        openImageModal(pureCallsign, card.download_url);
      });
      
      imageContainer.appendChild(img);
      cardDiv.appendChild(imageContainer);
      
      // 卡片底部添加呼号和类型标签
      const cardFooter = document.createElement('div');
      cardFooter.className = 'mt-2 text-center text-sm text-gray-700';
      
      // 显示纯呼号
      const callsignText = document.createElement('div');
      callsignText.textContent = pureCallsign;
      callsignText.className = 'font-medium';
      
      // 显示类型标签（6m/SAT）
      const typeTag = document.createElement('div');
      typeTag.className = 'mt-1 text-xs';
      const fileName = card.name.toLowerCase();
      if (fileName.includes('_6m')) {
        typeTag.innerHTML = '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full">6米波段</span>';
      } else if (fileName.includes('_sat')) {
        typeTag.innerHTML = '<span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">卫星</span>';
      } else {
        typeTag.innerHTML = '<span class="bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full">普通</span>';
      }
      
      cardFooter.appendChild(callsignText);
      cardFooter.appendChild(typeTag);
      cardDiv.appendChild(cardFooter);
      
      return cardDiv;
    }

    // 打开图片弹窗
    function openImageModal(callsign, imageUrl) {
      currentCallsign = callsign;
      currentFrontImageUrl = imageUrl;
      
      const modal = document.getElementById('image-modal');
      const modalTitle = document.getElementById('modal-image-title');
      const modalImage = document.getElementById('modal-image-front');
      const modalError = document.getElementById('modal-error-front');
      
      // 重置弹窗状态
      modalTitle.textContent = callsign;
      modalImage.src = buildProxyUrl(imageUrl);
      modalImage.classList.remove('hidden');
      modalError.classList.add('hidden');
      
      // 显示弹窗
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    // 处理搜索
    function handleSearch() {
      const searchTerm = document.getElementById('callsign-search').value.trim().toUpperCase();
      if (!searchTerm) return;
      
      const modal = document.getElementById('search-modal');
      const modalTitle = document.getElementById('modal-title');
      const modalContent = document.getElementById('modal-content');
      
      modalTitle.textContent = `搜索结果: ${searchTerm}`;
      
      // 筛选匹配的卡片
      const matches = allQslCards.filter(card => {
        const pureCallsign = getPureCallsign(card.name).toUpperCase();
        return pureCallsign.includes(searchTerm);
      });
      
      // 渲染搜索结果
      if (matches.length === 0) {
        modalContent.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa fa-search text-5xl mb-4"></i><p>未找到匹配的QSL卡</p></div>';
      } else {
        modalContent.innerHTML = `
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            ${matches.map(card => {
              const pureCallsign = getPureCallsign(card.name);
              return `
                <div class="card-hover">
                  <div class="image-container" data-callsign="${pureCallsign}" data-url="${card.download_url}">
                    <img src="${buildProxyUrl(card.download_url)}" alt="${pureCallsign}" loading="lazy">
                  </div>
                  <div class="mt-2 text-center text-sm text-gray-700">
                    <div class="font-medium">${pureCallsign}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        // 绑定搜索结果卡片点击事件
        document.querySelectorAll('#modal-content .image-container').forEach(container => {
          container.addEventListener('click', (e) => {
            const callsign = e.currentTarget.getAttribute('data-callsign');
            const url = e.currentTarget.getAttribute('data-url');
            openImageModal(callsign, url);
            // 关闭搜索弹窗
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          });
        });
      }
      
      // 显示搜索弹窗
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // 处理每页显示数量变更
    function handlePerPageChange(e) {
      itemsPerPage = parseInt(e.target.value);
      currentPage = 1; // 重置页码
      filterAndRenderCards();
    }

    // 上一页
    function goToPrevPage() {
      if (currentPage > 1) {
        currentPage--;
        filterAndRenderCards();
      }
    }

    // 下一页
    function goToNextPage() {
      const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        filterAndRenderCards();
      }
    }

    // 加载QSL卡列表
    function loadQslCards() {
      const cacheKey = `qslCards_${config.githubUser}_${config.githubRepo}`;
      const cacheTimeKey = `qslCardsCacheTime_${config.githubUser}_${config.githubRepo}`;
      
      // 检查缓存
      const cachedData = localStorage.getItem(cacheKey);
      const cachedTime = localStorage.getItem(cacheTimeKey);
      const now = new Date().getTime();
      
      // 如果缓存存在且未过期
      if (cachedData && cachedTime && (now - cachedTime) < (config.cacheExpireMinutes * 60 * 1000)) {
        allQslCards = JSON.parse(cachedData);
        updateLastUpdateTime(new Date(parseInt(cachedTime)));
        filterAndRenderCards();
        loadDXCCStats(); // 加载DXCC统计
        return;
      }
      
      // 从GitHub加载
      const apiUrl = `https://api.github.com/repos/${config.githubUser}/${config.githubRepo}/contents/${config.qslDir}`;
      
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) throw new Error('GitHub API 请求失败');
          return response.json();
        })
        .then(data => {
          // 过滤出图片文件
          const imageFiles = data.filter(item => {
            const name = item.name.toLowerCase();
            return name.endsWith('.jpg') || name.endsWith('.png') || name.endsWith('.jpeg');
          });
          
          // 按文件名排序
          imageFiles.sort((a, b) => a.name.localeCompare(b.name));
          
          // 保存到缓存
          localStorage.setItem(cacheKey, JSON.stringify(imageFiles));
          localStorage.setItem(cacheTimeKey, now.toString());
          
          // 更新数据
          allQslCards = imageFiles;
          updateLastUpdateTime(new Date());
          filterAndRenderCards();
          loadDXCCStats(); // 加载DXCC统计
        })
        .catch(error => {
          console.error('加载QSL卡失败:', error);
          document.getElementById('qsl-container').innerHTML = `
            <div class="col-span-full text-center py-16 text-gray-500">
              <i class="fa fa-exclamation-circle text-5xl text-primary mb-4"></i>
              <p>加载QSL卡列表失败，请稍后重试</p>
              <p class="text-sm mt-2">错误: ${error.message}</p>
            </div>
          `;
        });
    }

    // 更新最后更新时间
    function updateLastUpdateTime(date) {
      const formatted = date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('last-update').textContent = `最后更新：${formatted}`;
    }

    // 加载DXCC统计
    function loadDXCCStats() {
      const cacheKey = `dxccStats_${config.githubUser}_${config.githubRepo}`;
      const cacheTimeKey = `dxccStatsCacheTime_${config.githubUser}_${config.githubRepo}`;
      
      // 检查缓存
      const cachedData = localStorage.getItem(cacheKey);
      const cachedTime = localStorage.getItem(cacheTimeKey);
      const now = new Date().getTime();
      
      if (cachedData && cachedTime && (now - cachedTime) < (config.dxccCacheExpireMinutes * 60 * 1000)) {
        dxccStats = JSON.parse(cachedData);
        renderDXCCStats();
        return;
      }
      
      // 提取所有唯一呼号
      const uniqueCallsigns = [...new Set(allQslCards.map(card => getPureCallsign(card.name)))];
      
      // 批量查询DXCC
      const stats = {};
      let completed = 0;
      
      // 显示加载中
      document.getElementById('dxcc-stats').innerHTML = '<div class="text-sm text-gray-500">统计中...</div>';
      
      if (uniqueCallsigns.length === 0) {
        dxccStats = {};
        renderDXCCStats();
        return;
      }
      
      uniqueCallsigns.forEach(callsign => {
        fetch(`https://www.hamqth.com/json.php?callsign=${callsign}`)
          .then(response => response.json())
          .then(data => {
            completed++;
            if (data && data.results && data.results.dxcc) {
              const dxcc = data.results.dxcc;
              stats[dxcc] = (stats[dxcc] || 0) + 1;
            }
            
            // 所有查询完成
            if (completed === uniqueCallsigns.length) {
              dxccStats = stats;
              // 保存缓存
              localStorage.setItem(cacheKey, JSON.stringify(stats));
              localStorage.setItem(cacheTimeKey, now.toString());
              renderDXCCStats();
            }
          })
          .catch(error => {
            console.error(`查询${callsign}的DXCC失败:`, error);
            completed++;
            if (completed === uniqueCallsigns.length) {
              dxccStats = stats;
              localStorage.setItem(cacheKey, JSON.stringify(stats));
              localStorage.setItem(cacheTimeKey, now.toString());
              renderDXCCStats();
            }
          });
      });
    }

    // 渲染DXCC统计
    function renderDXCCStats() {
      const container = document.getElementById('dxcc-stats');
      container.innerHTML = '';
      
      if (Object.keys(dxccStats).length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500">暂无数据</div>';
        return;
      }
      
      // 按数量降序排序
      const sortedDXCC = Object.entries(dxccStats).sort((a, b) => b[1] - a[1]);
      
      // 渲染标签
      sortedDXCC.forEach(([dxcc, count]) => {
        const badge = document.createElement('div');
        badge.className = 'dxcc-badge';
        badge.textContent = `${dxcc} (${count})`;
        container.appendChild(badge);
      });
    }
  </script>
</body>
</html>
